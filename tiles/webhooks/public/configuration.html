<html>
<head>
    <link rel="stylesheet" type="text/css" href="{{{host}}}/stylesheets/style.css">
    <script src="{{{host}}}/javascripts/jquery-1.8.3.js"></script>
    <script src="{{{host}}}/javascripts/oauth2client.js"></script>
    <script src="{{{host}}}/webhooks/javascripts/main.js"></script>
    <script>
        $(document).ready( function() {
            
            var ticketErrorCallback = function() {
                alert('ticketErrorCallback error');
            };

            var jiveAuthorizeUrlErrorCallback = function() {
                alert('jiveAuthorizeUrlErrorCallback error');
            };


            var preOauth2DanceCallback = function() {
                $("#j-card-authentication").show();
                $("#j-card-configuration").hide();
                gadgets.window.adjustHeight(200);
            };

            var onLoadCallback = function( config, identifiers ) {
                onLoadContext = {
                    config: config,
                    identifiers : identifiers
                };
            };

            function doIt( host ) {

                var oauth2SuccessCallback = function(ticketID) {
                    // do configuration
                    $("#j-card-authentication").hide();
                    $("#j-card-configuration").show();

                    $("#btn_done").click( function() {
                        var toReturn = {
                            "data" : {}
                        };
                        console.log("toreturn", toReturn);
                        if ( ticketID ) {
                            toReturn['ticketID'] = ticketID;
                        }

                        jive.tile.close(toReturn );
                    });
                };

                var options = {
                    jiveOAuth2Dance : true,
                    serviceHost : host,
                    grantDOMElementID : '#oauth',
                    ticketErrorCallback : ticketErrorCallback,
                    jiveAuthorizeUrlErrorCallback : jiveAuthorizeUrlErrorCallback,
                    oauth2SuccessCallback : oauth2SuccessCallback,
                    preOauth2DanceCallback : preOauth2DanceCallback,
                    onLoadCallback : onLoadCallback,
                    authorizeUrl : host + '/oauth/authorizeUrl'
                };

                $("#btn_done").click( function() {
                    console.log(onLoadContext);
                });

                OAuth2ServerFlow( options ).launch();
            }

            doIt( '{{{host}}}');
        });
    </script>
</head>

<body>

<div id="j-card-authentication" class="j-card" style='display: none'>
    <p>The remote system (Jive) requires you to grant access before proceeding.</p>
    <button id="oauth">Grant Access</button>
</div>

<div id="j-card-configuration" class="j-card" style='display: none'>
    <h2>Thank you!</h2>

    <p>
    <p id="the_data"></p>
    <button id="btn_done">Close</button>
    </p>

</div>

</body>
</html>
